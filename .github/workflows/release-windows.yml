name: Release (Windows)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  windows:
    runs-on: windows-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: "3.41.1"
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2

      - name: Ensure Flutter Windows project files
        shell: pwsh
        run: |
          if (!(Test-Path ".\\recorderphone_ui")) {
            New-Item -ItemType Directory -Force ".\\recorderphone_ui" | Out-Null
          }
          Push-Location ".\\recorderphone_ui"
          flutter create --platforms=windows --overwrite .
          Pop-Location

      - name: Package (zip)
        shell: pwsh
        run: |
          powershell -ExecutionPolicy Bypass -File .\dev\package-windows.ps1 -Zip

          $tag = "${env:GITHUB_REF_NAME}"
          if ([string]::IsNullOrWhiteSpace($tag)) { $tag = "manual" }

          $src = Join-Path $env:GITHUB_WORKSPACE "dist\\windows\\RecorderPhone-windows.zip"
          $dst = Join-Path $env:GITHUB_WORKSPACE ("dist\\windows\\RecorderPhone-" + $tag + "-windows.zip")
          if (Test-Path $dst) { Remove-Item -Force $dst }
          Move-Item -Force $src $dst

          "ZIP_PATH=$dst" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
        id: package

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: RecorderPhone-${{ github.ref_name }}-windows
          path: ${{ steps.package.outputs.ZIP_PATH }}

      - name: Publish GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.package.outputs.ZIP_PATH }}
